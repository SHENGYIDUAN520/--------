# K230开发板通信协议

## 1. 概述

本文档描述了庐山派K230开发板与服务器端之间的通信协议，包括视频流传输、事件上报、指令下发等内容。本协议基于HTTP和TCP/WebSocket协议，用于实现K230开发板的AI检测结果和视频流传输。

**版本**: 1.1
**更新日期**: 2024-05-28

## 2. 通信架构

```
┌────────────┐                   ┌────────────┐                 ┌────────────┐
│            │  1. HTTP REST     │            │  WebSocket      │            │
│  K230      │<----------------->│  服务器     │<--------------->│  浏览器     │
│  开发板     │  2. TCP视频流     │            │                 │            │
│            │<----------------->│            │                 │            │
└────────────┘                   └────────────┘                 └────────────┘
```

K230开发板与服务器的通信分为两种方式：
1. HTTP REST API: 用于设备注册、状态上报、事件上报等
2. TCP视频流: 用于传输实时视频数据

服务器与浏览器通过WebSocket协议传输视频流数据。

## 3. 设备初始化与注册

### 3.1 设备启动流程

1. K230开发板启动后，首先读取本地配置
2. 连接到配置的WiFi网络
3. 向服务器发送设备注册请求
4. 接收服务器响应，获取配置参数
5. 根据配置初始化摄像头和AI模型
6. 开始视频采集和AI检测

## 4. TCP视频流协议

### 4.1 连接建立

K230开发板使用TCP Socket连接到服务器指定端口(默认8000)：

```python
streamer = VideoStreamer("服务器IP地址", 8000)
streamer.connect()
```

### 4.2 数据帧格式

每个视频帧按以下格式发送：

```
┌─────────────┬─────────────────────┐
│ 帧头(4字节)  │ JPEG图像数据         │
└─────────────┴─────────────────────┘
```

- 帧头: 4字节无符号整数(网络字节序)，表示JPEG图像数据的长度
- JPEG图像数据: 由帧头指定长度的JPEG压缩图像数据

### 4.3 发送流程

1. 获取RGB图像数据
2. 转换为JPEG格式并压缩
3. 添加4字节帧头指示JPEG数据大小
4. 通过TCP Socket发送完整数据包

示例代码:
```python
def send_frame(self, img_np):
    # 转换为JPEG字节流
    jpeg_buf = image.Image(img_np.shape[1], img_np.shape[0], 
                        image.RGB888, alloc=image.ALLOC_REF,
                        data=img_np.tobytes()).compress(quality=70)
    # 添加帧头
    header = struct.pack('!I', len(jpeg_buf))
    self.sock.sendall(header + jpeg_buf)
```

## 5. 服务器处理与WebSocket转发

服务器接收K230开发板发送的视频流，并通过WebSocket转发给浏览器:

1. 服务器监听TCP 8000端口，接收来自K230的连接
2. 解析TCP数据，提取视频帧
3. 将视频帧编码为Base64格式
4. 通过WebSocket将Base64编码的图像数据发送给浏览器

客户端使用WebSocket接收并显示视频流:
1. 浏览器通过WebSocket连接到服务器(/ws/video)
2. 接收Base64编码的JPEG图像
3. 使用img标签显示图像

## 6. 性能与质量控制

视频流传输的性能与质量控制参数:

- 分辨率: 1920×1080 (可配置)
- 帧率: 根据网络状况动态调整，最高25fps
- JPEG压缩质量: 70% (可在VideoStreamer中配置)
- 网络带宽: 建议≥2Mbps

为降低延迟和带宽占用，可以降低分辨率或压缩质量。
