# 智能陪护监控平台

## 项目概述
智能陪护监控平台是一个为老年人提供远程监控和健康管理的系统，使用Web技术实现，包括前端界面和后端API。

## 硬件配置

- **开发板**：立创·庐山派-K230-CanMV开发板
  - 处理器：嘉楠K230 AI芯片
  - 内存：512MB
  - 接口：40针树莓派兼容GPIO接口，支持I2C、SPI、UART等标准协议
  - AI能力：支持多种AI模型，如人脸检测、姿态识别、跌倒检测等
  - ADC接口：提供4路ADC输入（最高支持1.8V输入电压）
  - CSI接口：支持多达3路摄像头输入
- **摄像头**：立创·GC2093-200W摄像头-小镜头版-定焦70cm
  - 感光元件：GC2093
  - 最大分辨率：1920x1080
  - 最大帧率：60fps
  - 焦距：4.3MM
  - 视场角：D73°/H65°/V40°
  - 接口：22P 0.5mm间距CSI2接口
- **存储**：8G TF卡（Class10及以上，MK品牌推荐）
- **服务器**：本地服务器

## 技术栈

- 前端：HTML, CSS, JavaScript, ECharts
- 地图：高德地图API (Web端Key: bcd35feed546fa9b13211d11801e9c03)
- 后端：待定
- 服务器：阿里云ECS (IP: 47.97.160.91)

## 开发环境

### 本地开发环境

- **操作系统**: Windows 10/11
- **数据库**: MySQL 8.0 (本地实例)
- **前端服务**: 直接通过浏览器加载HTML文件
- **后端服务**: Python Flask (开发模式)
- **集成开发环境**: Visual Studio Code
- **K230开发环境**: CanMV IDE K230 (最新版本4.0.7+)

### 生产环境

- **服务器**: 本地服务器 (Windows 10/11 或 Ubuntu 20.04)
- **Web服务器**: Nginx 1.18+ (作为反向代理)
- **应用服务器**: Gunicorn + Flask (Linux) 或 Waitress + Flask (Windows)
- **数据库**: MySQL 8.0
- **监控**: Windows任务管理器或Linux系统监控

## 开发进度记录

### 2024-07-16 用户界面优化
- 移除了会话过期时显示的弹窗提示，改为静默处理
- 优化了API错误处理逻辑，提升用户体验
- 简化了401未授权错误的处理方式，不再打断用户操作

### 2024-07-16 解决登录跨域(CORS)问题
- 修复了登录API请求中的跨域(CORS)问题
- 解决了`Access-Control-Allow-Credentials`头重复设置导致的浏览器拒绝响应问题
- 优化后端Flask应用程序的CORS配置，移除了手动添加的CORS响应头
- 让Flask-CORS扩展统一处理所有CORS相关头部信息
- 确保前端从`http://198.18.0.1:5000`访问后端API `http://127.0.0.1:5000/api/auth/login`时能正常工作

### 2024-07-12 深度优化高德地图性能与缓存机制
- 实现了位置和医院数据的本地缓存机制，大幅提升了二次加载速度
- 添加了地图资源完整清理功能，避免潜在的内存泄漏问题
- 优化了地图加载超时处理，改进检测逻辑
- 增加了浏览器功能检测，提前发现兼容性问题
- 添加了页面可见性状态监听，优化在后台/前台切换时的地图加载行为
- 改进了2D地图模式配置，大幅提升弱网络环境下的加载性能
- 优化了默认医院列表，增加了备选医疗机构
- 增强了错误处理机制，所有操作添加了try-catch保护

### 2024-07-10 高德地图API配置修复与优化
- 更新了高德地图API配置，修复了securityJsCode与API Key不匹配的问题
- 优化了地图加载流程，增加了缓存防护机制
- 切换至2D地图模式，提高了兼容性和加载速度
- 改进了医院标记样式，添加了动画效果和更友好的信息窗口
- 完善了地图加载状态追踪，确保不会出现超时误判
- 通过异步加载避免了可能的渲染冲突
- 添加了更完善的错误捕获和处理机制

### 2024-07-09 地图显示与医院信息优化
- 修复了地图无法正常显示的问题，增强了错误处理机制
- 优化了医院信息区域的样式，使其与系统深色主题风格一致
- 改进了地图加载状态显示，提供了友好的加载过程反馈
- 实现了离线检测功能，在网络不可用时自动使用默认数据
- 优化了错误提示UI，提高了用户友好度和信息可读性
- 统一了图标样式，使用Bootstrap图标替换了FontAwesome图标
- 改进了默认数据的显示机制，确保在各种异常情况下系统可用性

### 2024-07-08 高德地图定位功能优化
- 改进了高德地图加载逻辑，解决定位权限和网络连接问题
- 优化了地图容器初始化过程，确保地图信息显示更加稳定
- 添加了默认位置和医院显示机制，即使在定位失败时也能正常工作
- 改进了地图错误处理和UI提示，提供更友好的用户体验
- 优化了医院信息窗口样式，增强视觉效果和可读性
- 添加了响应式设计支持，确保在不同设备上都能正确显示
- 完善了标记点清理和管理机制，避免标记重复显示问题

### 2024-07-01 紧急报警UI深度优化
- 优化了视频加载提示的可见度，改用白色文字
- 改进了标题栏设计，添加渐变背景和阴影效果
- 优化了弹窗整体视觉效果，增加层次感
- 改进了移动端适配，优化按钮布局和触摸体验
- 统一了设计语言，提升了整体质感
- 优化了文字排版和间距，提高可读性
- 改进了交互反馈效果

### 2024-06-30 高德地图API功能优化

- 优化高德地图API加载和初始化流程，提高地图组件可靠性
- 完善附近医院搜索功能，增强结果处理和错误容错机制
- 增加地图控件（缩放、比例尺、定位等），提升用户交互体验
- 为医疗设施标记添加信息窗体，点击标记可查看详细信息
- 优化地图定位失败的处理逻辑，自动使用昆明理工大学作为默认位置
- 改进医疗设施分类显示，区分医院、诊所和药店不同图标样式
- 处理搜索结果为空的情况，显示默认医疗设施数据确保UI一致性

### 2024-06-29 K230开发板通信协议实现与优化

- 将K230开发板通信协议从阿里云服务器迁移到本地服务器配置
- 实现基于HTTP的设备注册、状态上报、事件上报等功能
- 完善UDP视频流传输机制，优化视频帧传输格式
- 支持跌倒检测、姿态异常等AI事件的实时上报
- 增强服务器与K230开发板之间的心跳机制
- 更新示例代码中的服务器地址为本地地址，便于开发调试
- 完善错误处理机制，确保设备与服务器通信稳定

### 2024-06-01 页面功能优化与交互改进

- 修复紧急联系人面板无法滚动的问题，添加滚动功能使所有联系人可见
- 优化联系人面板样式，改进UI显示效果，包括联系人卡片布局和间距
- 美化滚动条样式，提升用户体验
- 确保"刘叔叔"作为邻居联系人也被包含在默认数据中
- 统一联系人卡片样式，优化电话按钮显示

### 2024-05-31 UI优化与系统调整

- 彻底移除状态检测面板中的心率、活动和体温指示器部分，保持界面简洁
- 修改静坐时间管控图表颜色，将活动颜色改为绿色(#4CAF50)，保持静坐为红色(#FF6B6B)
- 在紧急联系人默认数据中增加"邻居"联系人，提升数据完整性
- 统一UI颜色方案，确保视觉呈现一致性
- 优化页面布局结构，移除不需要的UI元素

### 2024-05-30 界面UI优化与功能调整

- 移除状态检测面板中的心率、活动和体温指示器，仅保留图表显示
- 修改静坐时间管控图表颜色，使其与设计UI匹配（活动：绿色，静坐：红色）
- 在紧急联系人中增加"邻居"作为默认数据，增强数据完整性
- 优化数据为空时的默认数据处理，提高用户体验
- 调整各图表的颜色方案，使整体视觉效果更协调
- 统一错误处理逻辑，确保在API访问失败时能显示合理的默认数据

### 2024-05-29 前端数据加载优化

- 优化main.js文件中的数据加载逻辑，改进API请求错误处理
- 增强getRequest函数调用，确保正确处理加载指示器
- 实现数据加载失败时使用默认数据，提高用户体验
- 完善各面板更新函数中的错误处理，增加try-catch机制
- 优化面板更新逻辑，支持部分数据更新且保留默认值
- 为所有API调用添加console日志，便于调试
- 修改联系人UI更新逻辑，保留加载指示器元素

### 2024-05-27 系统设置功能优化与数据库对接

- 完善系统设置模块中的账户设置功能，实现与API的对接
- 优化老人管理功能，实现老人信息的添加、编辑和删除
- 完善紧急联系人管理系统，实现与老人信息的关联
- 修改模态窗口表单内容，确保与后端API数据结构匹配
- 优化页面数据加载和表单提交流程
- 实现实时数据验证和用户友好的错误提示

### 2024-05-25 前后端集成与数据流优化

- 完成数据库API与前端页面的深度集成
- 优化视频流处理模块，实现实时视频传输和存储
- 改进前端用户认证流程，增强安全性
- 老人信息管理系统功能完善，支持批量导入与导出
- 统一数据获取接口，采用RESTful API标准
- 解决跨域问题，确保开发环境和生产环境一致性
- 规划K230开发板与服务器间的通信协议升级

### 2024-05-23 用户管理功能增强

- 实现用户注册功能，添加前端注册页面(register.html)和相关业务逻辑
- 完善用户信息验证机制，包括密码强度检查、邮箱格式验证等
- 优化登录/注册页面UI，添加表单验证和用户友好提示
- 增强前后端用户系统对接，改善用户体验

### 2024-05-15 数据库与API对接

- 创建并成功初始化MySQL数据库，建立基本表结构
- 移除Redis相关代码，统一使用MySQL作为唯一数据存储
- 实现数据库API模块(database/api.py)，提供各类数据操作接口
- 创建Flask应用程序(app.py)，实现RESTful API接口
- 前端页面重构，移除本地静态数据，改为动态加载结构
- 实现用户认证、会话管理等基础功能

### 2024-05-10 前端页面基础开发

- 开发首页仪表盘界面，包含多个数据展示面板
- 实现老人详情页面，用于展示老人基本信息和活动数据
- 开发视频监控页面，支持实时视频流显示和录制功能
- 实现系统设置页面，包含用户管理、设备配置等功能
- 添加页面导航和基础样式

### 2024-05-05 数据库设计与配置

- 设计数据库表结构，包括用户、老人信息、设备、报警事件等
- 配置MySQL数据库连接
- 初步规划Redis缓存(后决定不使用)
- 编写数据库初始化脚本

### 2024-04-30 项目初始化

- 确定项目架构和技术栈
- 设置开发环境
- 创建项目基础目录结构
- 编写项目需求文档

### 2024-06-28 服务器配置更改为本地服务器

- 将服务器配置从阿里云(47.97.160.91)更改为本地服务器(localhost)
- 更新相关配置文件中的服务器地址
- 修改API调用地址，使用本地地址进行开发和测试
- 简化开发流程，便于本地调试和开发
- 优化前端API请求，增强错误处理逻辑
- 添加服务器地址配置的灵活性，可通过设置界面轻松切换

### 2024-04-18 高德地图功能优化
- 重构地图初始化代码，解决加载错误问题
- 优化地图组件加载方式，使用异步加载提高页面性能
- 添加地图加载失败的容错处理
- 实现地图控件的按需加载
- 优化医疗设施搜索逻辑
- 添加默认位置（昆明理工大学）作为定位失败的备选方案
- 完善地图标记和信息窗体的显示效果

### 2024-04-18 老人详情页面功能完善
- 为老人详情页面(detail.html)添加了本地默认数据
- 实现了以下功能：
  - 基本信息展示（老人姓名、年龄、房间号等）
  - 今日活动统计（起床、就寝时间、用餐记录等）
  - 异常记录列表
  - 实时时间显示
  - 视频监控模拟功能（连接、截图、全屏）

### 2024-07-01 后端API和地图功能修复
- 实现了后端API接口，添加了所有必要的数据接口
- 修复了地图容器不存在的问题
- 优化了地图初始化逻辑和错误处理
- 改进了医院搜索功能，添加了默认数据支持
- 优化了最近医院信息的显示效果
- 添加了地图加载失败时的容错处理

### 2024-07-15 老人和联系人管理功能增强
- 为老人管理和联系人管理功能添加了本地数据存储功能，解决离线使用问题
- 优化了老人数据加载逻辑，增加了从本地存储加载数据的备选方案
- 移除了老人和联系人管理界面中重复的添加按钮，使界面更加简洁
- 改进了数据保存失败的处理方式，提供优雅的降级策略
- 实现数据修改时同步更新本地存储，确保本地备份数据的一致性
- 增强了老人信息和联系人数据的离线编辑功能
- 实现了本地数据删除功能，同步更新UI显示

### 2024-07-17 API认证与服务器连接优化
- 修复了401未授权错误处理机制，提供更友好的用户提示
- 优化了服务器地址配置，确保API请求使用正确的服务器地址
- 改进了localStorage中配置的读取方式，解决服务器地址不一致问题
- 添加了认证错误的悬浮提示功能，自动显示登录按钮
- 优化API请求日志，增加更多详细信息便于调试
- 完善了测试用户的创建和认证机制，降低配置门槛
- 增加了认证相关的状态提示，改善用户体验
- 确保本地数据存储功能在API服务不可用时正常工作

### 2024-05-30 高德地图问题修复
1. 修复了高德地图安全码配置问题
   - 将securityJsCode更新为与服务器端API匹配的值
   - 解决了医疗设施搜索失败的INVALID_USER_SCODE错误
2. 优化了地图加载与错误处理
   - 将地图模式从3D改为2D，提高兼容性和加载速度
   - 禁用了地图缓动效果，提高性能
   - 改进了错误处理机制，为所有操作添加try-catch保护
3. 完善了定位失败处理
   - 更好地处理非HTTPS环境下的定位失败问题
   - 优化了默认位置和医院信息显示
   - 添加了更详细的错误日志记录

### 2024-05-29
1. 修复了高德地图加载问题
   - 创建了`amap.js`文件实现地图初始化功能
   - 添加了`initAMap`回调函数
   - 实现了附近医疗设施搜索功能
2. 修复了main.js中的错误
   - 删除了对不存在元素'center-loading'的引用

### 2023-11-06
- 修复了CORS跨域问题，特别是登录API的凭据处理问题
- 调整了Flask后端的CORS配置，添加了`supports_credentials=True`和相关头部
- 修改了前端API请求配置，使用相对路径避免跨域问题
- 添加了全局OPTIONS预检请求处理，确保CORS预检请求正常工作
- 调整了Cookie设置，添加了`samesite='Lax'`属性增强安全性

## 项目结构

```
智能陪护监控平台/
│
├── database/               # 数据库相关模块
│   ├── __init__.py         # 数据库模块入口
│   ├── mysql_db.py         # MySQL连接和操作
│   ├── api.py              # 数据库API接口
│   ├── config.py           # 数据库配置
│   └── init_db.py          # 数据库初始化脚本
│
├── static/                 # 前端静态资源
│   ├── css/                # 样式文件
│   ├── js/                 # JavaScript文件
│   │   ├── common.js       # 通用JavaScript函数
│   │   ├── main.js         # 主页面脚本
│   │   ├── login.js        # 登录页面脚本
│   │   └── register.js     # 注册页面脚本
│   ├── img/                # 图片资源
│   ├── index.html          # 首页
│   ├── detail.html         # 老人详情页
│   ├── video.html          # 视频监控页
│   ├── settings.html       # 系统设置页
│   ├── login.html          # 登录页面
│   └── register.html       # 注册页面
│
├── app.py                  # Flask应用程序入口
├── requirements.txt        # 项目依赖
└── README.md               # 项目说明文档
```

## 核心功能

- 实时视频监控：支持多路摄像头，提供流畅的视频流显示
- 跌倒检测与报警：利用YOLOv5n-falldown模型实时检测老人跌倒情况
- 人脸识别与老人识别：使用K230内置的人脸识别功能识别老人身份
- 姿态异常检测：基于YOLOv8n-pose模型分析老人姿态是否异常
- 历史录像存储与回放：支持录像的存储、检索和回放
- 设备管理：支持摄像头的添加、配置和状态监控
- 用户权限管理：分级权限控制，支持管理员、工作人员和家属角色
- 报警事件管理与处理：报警事件的记录、通知和处理流程

## 系统架构

1. **前端部分**
   - 用户管理界面：管理系统用户，分配权限
   - 视频监控界面：实时展示多路摄像头画面，显示警报信息
   - 老人详情界面：展示老人基本信息和历史记录
   - 历史记录查询界面：检索和播放历史视频记录
   - 报警通知与处理界面：显示报警事件，提供处理操作
   - 设置界面：系统参数配置，设备管理

2. **后端部分**
   - Flask Web服务器：提供API接口，处理前端请求
   - 视频流处理模块：接收并处理K230发送的视频流
   - 数据库存储与查询模块：管理MySQL数据操作
   - 用户认证与权限控制模块：JWT认证和权限验证
   - 报警事件处理模块：处理异常事件，发送通知
   - WebSocket实时通信：实现报警的实时推送

3. **数据库设计**
   - 用户管理表：存储用户信息和权限
   - 老人信息表：记录老人基本信息
   - 摄像头设备表：管理摄像头配置和状态
   - 视频记录表：存储录像文件信息
   - 报警事件表：记录异常事件详情和处理状态
   - 设备状态表：记录设备的在线状态和最后活动时间
   - 临时会话表：存储用户会话和临时数据

4. **边缘计算部分**
   - 庐山派K230开发板：搭载嘉楠K230 AI芯片
   - 摄像头视频采集：支持多路摄像头输入
   - 本地AI推理：在边缘设备上进行AI模型推理
     - 跌倒检测：使用YOLOv5n-falldown模型
     - 姿态识别：使用YOLOv8n-pose模型
     - 人脸识别：使用K230内置模型
   - 报警事件上传：通过HTTP接口上传异常事件
   - UDP视频流传输：通过UDP协议传输视频帧

## 下一步计划

1. 完善视频监控页面，实现多摄像头画面同时显示
2. 优化前端数据刷新机制，减少不必要的API请求
3. 添加老人活动统计图表，支持时间段筛选
4. 实现报警事件历史查询功能
5. 开发移动端响应式界面，支持手机访问
6. 集成WebSocket，实现实时告警推送
7. 完善K230开发板跌倒检测算法，提高准确率
8. 增加系统日志记录和审计功能

## 项目成员

- 开发人员：昆明理工大学物联网工程专业学生
- 指导老师：xxx

---

最后更新：2024-07-12

## 开发进度

### 2024-03-21
1. 修复了紧急警报窗口的UI溢出问题
   - 设置了最大宽度和高度限制
   - 添加了响应式布局支持
   - 优化了滚动条样式

2. 优化了高德地图加载机制
   - 添加了地图加载超时处理（20秒）
   - 实现了加载失败的错误提示界面
   - 增加了网络状态监听，自动处理断网情况
   - 添加了重试机制和用户友好的错误提示

## 待解决问题
1. 继续优化地图加载性能
2. 完善错误处理机制
3. 优化用户界面响应速度

## 下一步计划
1. 实现更多地图交互功能
2. 添加用户位置历史记录功能
3. 优化移动端适配

## 开发进度

### 2024-03-xx
1. 完成settings.js核心功能开发：
   - 老人信息管理系统
   - 联系人管理功能
   - UI交互优化
   - 数据同步机制

### 主要功能模块

#### 1. 老人信息管理
- 保存、加载、删除老人数据
- 字段：姓名、年龄、性别、紧急联系人、电话号码等
- 表单验证和错误处理

#### 2. 联系人管理
- 联系人数据的保存和加载
- 字段：姓名、与老人关系、电话号码、关联老人ID
- 动态关联老人信息

#### 3. UI交互优化
- 加载状态管理
- 空数据状态处理
- 错误消息提示
- 操作确认机制
- 表单验证反馈

#### 4. 数据同步
- API实时更新
- 本地列表刷新
- 错误处理机制

#### 5. 系统配置
- 服务器配置管理
- 连接测试功能
- 配置持久化存储

#### 6. 通知系统
- Toast消息提示
- 多种消息类型支持
- 动画效果
- 自动关闭机制

## 待开发功能
1. [ ] 实时监控模块
2. [ ] 智能分析系统
3. [ ] 报警提醒功能
4. [ ] 移动端适配
5. [ ] 数据统计报表

## 技术栈
- 前端：HTML5, CSS3, JavaScript, ECharts
- 后端：Python, Flask
- 数据库：MySQL
- 图像处理：OpenCV, Paddle
- 部署：本地服务器

## 开发环境

### 本地开发环境

- **操作系统**: Windows 10/11
- **数据库**: MySQL 8.0 (本地实例)
- **前端服务**: 直接通过浏览器加载HTML文件
- **后端服务**: Python Flask (开发模式)
- **集成开发环境**: Visual Studio Code
- **K230开发环境**: CanMV IDE K230 (最新版本4.0.7+)

### 生产环境

- **服务器**: 本地服务器 (Windows 10/11 或 Ubuntu 20.04)
- **Web服务器**: Nginx 1.18+ (作为反向代理)
- **应用服务器**: Gunicorn + Flask (Linux) 或 Waitress + Flask (Windows)
- **数据库**: MySQL 8.0
- **监控**: Windows任务管理器或Linux系统监控

## 开发进度记录

### 2024-05-29
1. 修复了高德地图加载问题
   - 创建了`amap.js`文件实现地图初始化功能
   - 添加了`initAMap`回调函数
   - 实现了附近医疗设施搜索功能
2. 修复了main.js中的错误
   - 删除了对不存在元素'center-loading'的引用

### 待办事项
1. 完善地图功能
   - 优化地图加载体验
   - 添加更多POI类型搜索
2. 实现后端API对接
   - 开发真实数据接口
   - 实现用户认证
3. 完善监控功能
   - 添加实时视频监控
   - 优化睡眠和静坐时间监控

## 待完成任务
- 完成首页、视频监控页和系统设置页的UI改版
- 实现与后端的数据交互
- 完善视频监控功能
- 开发异常事件提醒和处理功能
- 添加用户管理和登录功能
